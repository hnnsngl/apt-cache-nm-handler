#! /bin/bash

# auto-configuration for APT proxy setting 
#
# copy script to /etc/NetworkManager/dispatch.d and configure /etc/apt-proxies

configfile="/etc/apt-proxies"
proxyconfig="/etc/apt/apt.conf.d/10proxy"

function setproxy() # proxyhost proxyport
{
    proxyhost=$1
    proxyport=$2

    if [ -z $proxyport ] ; then
	proxyport="3142"
    fi

    if [ -z $proxyhost ] ; then
	echo failed
	return 1
    fi

    echo "Configuring APT proxy $proxyhost:$proxyport for network $network"
    if echo foo | nc $proxyhost $proxyport ; then
	if [ ! -w $proxyconfig ] ; then
	    echo "Error: $proxyconfig file is not writable"
	    exit 1
	fi

	cat > $proxyconfig <<EOF
# Automatically generated by $0 using config file $configfile
Acquire::http { Proxy "http://${proxyhost}:${proxyport}" ; }
Acquire::http { Proxy "https://" ; }
EOF
	return 0
    else
	echo "Error: cannot connect to host"
    fi
}

function unsetproxy()
{
    echo "Removing APT proxy configuration for this connection"
    cat > $proxyconfig <<EOF
# Automatically generated by $0
#
# No APT proxies configured for this network yet
EOF
}

# main
# check for config file
if [ ! -f $configfile ] ; then
    cat > $configfile <<EOF
domain1  host.domain1  3142
domain2  host.domain2  3142
EOF
fi

# lookup network using search domain in /etc/resolv.conf
mynetworks=$(awk '/search/{for(i=2; i<=NF; i++) print $i}' /etc/resolv.conf)
for network in $mynetworks ; do
    echo "Network: $network"
    while read pattern proxy port ; do
	echo "  Pattern $pattern --> $proxy:$port"
	if [[ $network == $pattern ]] ; then
	    setproxy $proxy $port && exit 0
	fi
    done < $configfile
done
# no match found -- remove the proxy config snippet
unsetproxy
